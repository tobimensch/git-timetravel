#!/usr/bin/python
"""travel back in time in a git repository, by just entering
 * a number of commits you want to go back (or a hash).
 * When you want get back to 'now' including the local changes
 * git-timetravel now takes you back into the future.
 * Repository and issue-tracker: https://github.com/docopt/docopt
 * Licensed under terms of MIT license (see LICENSE-MIT)
 * Copyright (c) 2013 Vladimir Keleshev, vladimir@keleshev.com
 * Copyright (c) 2014 Tobias Glaesser

"""
import os
import sys
import re
import datetime
import subprocess
import tempfile

from docopt import docopt

__all__ = ['git-timetravel']
__version__ = '0.1.0'

doc ='''
Usage:
  git-timetravel back [NUM]
  git-timetravel forward [NUM]
  git-timetravel anchor
  git-timetravel <commit>
  git-timetravel --help
  git-timetravel --version

Travel in time through your git repository.
Then go back to the future with git-timetravel anchor,
not losing any local changes.

When you first go back using <commit> or back [num]
git-timetravel remembers where you were as the anchor.
If you then use the anchor command at any time you'll be taken
back to that anchor.

This tool is intended for trying earlier revisions of code,
i.e. to test for regressions.

arguments:
  <commit>                     go back to specific commit
                               will refuse going forward

commands:
  back [NUM]                   go back by [NUM] commits
                               (default is 1)
  forward [NUM]                go forward by [NUM] commits
                               (default is 1)
  anchor                       get back to the anchor including
                               any local changes

Options:
  -h, --help                   show this help message and exit
  -v, --version                display version information

'''

opt = docopt(doc,None,True,__version__)

def set_anchor():
    a = get_anchor()
    if a != None:
        print "Error: Will not set timetravel anchor, because one is set already"
        return
    #only set anchor if none is set
    f = open('.git/timetravel_anchor','w+')
    f.write('master')
    f.close()

def get_anchor():
    ''
    try:
        f = open('.git/timetravel_anchor','r')
    except:
        return None
    if f:
        a = f.readline()
        f.close()
        if a == '':
            return None
        else:
            #test if a is a valid anchor
            return a.strip()
    else:
        return None     

    #if no anchor is set return None

def get_num(n):
    if n:
        return n
    return "1"

def travel_to_anchor():
    #travel to anchor / git checkout (anchor)
    a = get_anchor()
    if a == None:
        print "Error: No anchor found, can't travel."
        exit(0)
    #validation of anchor?
    #stash local changes so there's no problem traveling
    stash_changes()
    p = subprocess.Popen(['git','checkout',a], stdout=subprocess.PIPE)
    #then remove the anchor
    os.unlink('.git/timetravel_anchor')
    #then apply stashed changes
    p = subprocess.Popen(['git','stash','apply'], stdout=subprocess.PIPE)

def stash_changes():
    if not are_there_changes():
        return #nothing to stash my friend

    #find out if there are local changes
    #if so create stash
    p = subprocess.call('git stash',shell=True)
    if p != 0:
        print "Error while running git stash... not secure to continue"
        exit(1)

def are_there_changes():
    p = subprocess.Popen(['git','diff'], stdout=subprocess.PIPE)
    out, err = p.communicate()
    if p.returncode != 0:
        print "Error while running git diff... not secure to continue"
        exit(1)
    if out == '':
        #apparently no changes
        return False
    else:
        return True

def travel_to(destination):
    print "Charging timemachine with energy... 1 ... 2 ... 3 ... "
    num = get_num(opt['NUM'])
    set_anchor()
    stash_changes() 
    print 'git checkout '+destination
    subprocess.call('git checkout '+destination,shell=True)

if opt['anchor']: #going back to the way things were #back to the future
    travel_to_anchor()
    exit(0)

elif opt['back']:
    num = get_num(opt['NUM'])
    travel_to("HEAD~"+num)

elif opt['forward']: #similar to back but also very different
    #first we have to go to the anchor
    #then we can go forward by not going backward too much
    #while keeping the original anchor
    num = get_num(opt['NUM'])
    travel_to_anchor()

elif opt['<commit>']: #similar to back
    travel_to(opt['<commit>'])

